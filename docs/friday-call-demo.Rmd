---
title: "REDCap Custodian Friday Call Demo"
author: "Philip Chase & Kyle Chesney"
date: '2022-06-15'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This is a demonstration of some features of the REDCap Custodian R package. 

We will demonstrate how to:

1. Fetch and store you API tokens in a database
2. Get some data from a REDCap project
3. Transform your data
4. Write it to another project
5. Review the logs of what the job

Then we'll talk about how to automate that whole process.

## Prequisites

Follow the steps and run the code provided in friday-call-demo-setup.Rmd.

## Premise

You have a big important project with many rows of data and many more rows coming in every week, a researcher asks you to build them a biorepository project for the biospecimens collected for this protocol. We do not want anyone to transcribe existing data, so we will _automatically_ copy it for them every day. No transcription, no typos, no overtime.

## Create some data for your REDCap project

We will generate some records for your main project for you to port over to the Biospecimen project. First, access the credential database to get your credentials to the REDCap project you want to read from.

```{r read_source_credentials_from_db}
source_credentials <- tbl(file_conn, "credentials") %>%
  filter(username == my_username) %>%
  collect() %>%
  filter(str_detect(project_display_name, "Demo Main")) %>%
  unnest()
```

We use Will Beasley's REDCapR library to interact with REDCap via its API. REDCapR allows you to specify the forms, fields, event names, and time frames of interest. It even allows REDCap filtering.

It isn't entirely necessary to understand most the following block as you typically won't be populating a project with random data.

```{r create data}
record_count_to_create <- 50
collection_events <- 5
tubes_per_collection <- 30

record_columns <- c(
  "record_id",
  "redcap_event_name",
  "sample_collected_date",
  "tmp_event_id",
  paste0("tube_id", 1:tubes_per_collection),
  paste0("tube_specimen_type", 1:tubes_per_collection),
  paste0("tube_volume", 1:tubes_per_collection)
  )

# create empty dataframe and set column names
simulated_data <- data.frame(
  matrix(ncol = length(record_columns), nrow = 0)
) %>%
  mutate(across(everything(), as.character))
colnames(simulated_data) <- record_columns

# create base entries for each event
# NOTE: may be a bit slow as for-loops are not generally used in R
for (record_id in 1:record_count_to_create) {
  for (event_id in 1:collection_events) {
    simulated_data <- simulated_data %>%
      add_row(
        record_id = as.character(record_id),
        redcap_event_name = paste0("event_", event_id, "_arm_1"),
        tmp_event_id = as.character(event_id), # used to generate tube IDs later
        sample_collected_date = sample(
          seq(ymd("2020-03-01"), ymd("2022-06-01"), by = "day"), size = 1, replace = T
        ) %>% as.character()
      )
  }
}

# group to ensure simulated data is consistent with a single collection event
simulated_data <- simulated_data %>%
  group_by(record_id, redcap_event_name)

# simulate individual samples
for (tube in 1:tubes_per_collection) {
  simulated_data <- simulated_data %>%
    mutate(
      "tube_id{tube}" := paste0(
        record_id, "-",
        str_pad(tmp_event_id, width = 2, side = "left", pad = "0"), "-",
        str_pad(tube, width = 2, side = "left", pad = "0")
      ),
      "tube_specimen_type{tube}" := sample(1:4, size = 1),
      "tube_volume{tube}" := sample(2:4, size = 1)
    )
}

# remove temporary column used in simulation
simulated_data <- simulated_data %>%
  ungroup() %>%
  select(-tmp_event_id)

# upload data to REDCap
REDCapR::redcap_write(
  redcap_uri = source_credentials$redcap_uri,
  token = source_credentials$token,
  ds_to_write = simulated_data
)
```

## Get some data from a REDCap project

At this point it's time to read the portions of the project data that interest you.

For our task, we want to read identifiers for collected data so we can write them into the Biospecimen tracking project

```{r read data}

fields_to_read <- c(
  "record_id",
  "redcap_event_name",
  "sample_collected_date",
  paste0("tube_id", 1:tubes_per_collection),
  paste0("tube_specimen_type", 1:tubes_per_collection),
  paste0("tube_volume", 1:tubes_per_collection)
)

source_project_data <- REDCapR::redcap_read(
  redcap_uri = source_credentials$redcap_uri,
  token = source_credentials$token,
  fields = fields_to_read
)

# Validate that data was retrieved and alert regarding issues
if (!source_project_data$success) {
  warning("Data was not successfully read from REDCap")
}
```

Our customer's requirements for the biorepository require us to do some transformations before writing. That's easy with the `dplyr` library

```{r transform_source}

# Append the event number to the subject_id to make the record_id needed in the biorepository
new_target_project_data <- source_project_data$data %>%
  rename(subject_id = record_id) %>%
  mutate(record_id = paste0(
    subject_id, "-",
    str_replace(redcap_event_name, "event_", "") %>% str_replace(., "_arm_1", ""))) %>%
  select(record_id, everything()) %>%
  rename(date_draw = sample_collected_date)
```

Now write that data to the target project

```{r write_to_target}
target_credentials <- tbl(file_conn, "credentials") %>%
  filter(username == my_username) %>%
  collect() %>%
  filter(str_detect(project_display_name, "Demo Biospecimen")) %>%
  unnest()

# Want to know exactly what is getting updated in the target project? Fetch that data then anti-join with the new data set
target_fields_to_read <- c(
  "record_id",
  "redcap_event_name",
  "sample_collected_date"
)

old_target_project_data <- REDCapR::redcap_read(
  redcap_uri = target_credentials$redcap_uri,
  token = target_credentials$token,
  fields = target_fields_to_read
)

target_project_data <- new_target_project_data %>%
  dplyr::anti_join(old_target_project_data$data)

# now write that small dataset
REDCapR::redcap_write(
  ds_to_write = slice_head(target_project_data, prop= 0.5),
  redcap_uri = target_credentials$redcap_uri,
  token = target_credentials$token
)
```

## Review the logs of what the job

When doing automated jobs, it's important to have a record of what happened. REDCap Custodian writes logs so you can review its actions later.

```{r read_logs}


```
